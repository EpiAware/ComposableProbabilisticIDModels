name: Render and Deploy Quarto Paper

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  actions: write
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent build per branch, canceling in-progress runs
# when new commits are pushed.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Render the paper (Quarto)
  render-paper:
    runs-on: ubuntu-latest
    outputs:
      has-artifacts: ${{ steps.check-outputs.outputs.has-artifacts }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Setup Julia
        uses: julia-actions/install-juliaup@v2
        with:
          channel: '1.11.6'

      - name: Set Julia version as default
        run: juliaup override set 1.11.6

      - name: Cache Julia
        uses: julia-actions/cache@v2
        with:
          cache-name: julia-cache-${{ hashFiles('Manifest.toml') }}
          cache-registries: true
          cache-compiled: true

      - name: Install Julia dependencies
        run: |
          julia +1.11.6 --project=. -e '
            using Pkg
            Pkg.instantiate()
            Pkg.precompile()
          '

      - name: Cache Quarto
        uses: actions/cache@v4
        with:
          path: |
            .cache
            .quarto/project-cache
            _freeze/
            figures/
          key: ${{ runner.os }}-${{ github.ref_name }}-quarto-${{ hashFiles('index.qmd', 'case-studies.qmd', 'README.md', '_quarto.yml') }}
          restore-keys: |
            ${{ runner.os }}-${{ github.ref_name }}-quarto-
            ${{ runner.os }}-main-quarto-

      - name: Install librsvg for SVG to PDF conversion
        run: sudo apt-get update && sudo apt-get install -y librsvg2-bin

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: "1.8.24"
          tinytex: true

      - name: Install Quarto extensions
        run: quarto install chromium

      - name: Validate Quarto project
        run: quarto check

      - name: Render Quarto project
        run: |
          quarto render
        env:
          JULIA_NUM_THREADS: auto

      - name: Render README as homepage
        run: |
          mkdir -p .tmp
          cat .github/readme-header.yml README.md > .tmp/README.md
          quarto render .tmp/README.md --to html
          mv .tmp/README.html README.html
          rm -rf .tmp

      - name: Check for outputs
        id: check-outputs
        run: |
          outputs_exist="false"
          if [ -f "index.pdf" ]; then
            outputs_exist="true"
          fi
          echo "has-artifacts=$outputs_exist" >> $GITHUB_OUTPUT
          echo "Found outputs: $outputs_exist"

      - name: Copy artifacts to _site for GitHub Pages
        run: |
          mkdir -p _site
          cp README.html _site/index.html 2>/dev/null || echo "README HTML not found"
          cp index.html _site/paper.html 2>/dev/null || echo "Paper HTML not found"
          cp index.pdf _site/paper.pdf 2>/dev/null || echo "PDF file not found"
          cp index.docx _site/paper.docx 2>/dev/null || echo "Paper DOCX not found"
          cp case-studies.html _site/ 2>/dev/null || echo "Case studies HTML not found"
          cp case-studies.pdf _site/ 2>/dev/null || echo "Case studies PDF not found"
          cp case-studies.docx _site/ 2>/dev/null || echo "Case studies DOCX not found"
          cp -r site_libs _site/ 2>/dev/null || echo "Site libs not found"
          cp Project.toml _site/ || echo "Project.toml not found"
          cp Manifest.toml _site/ || echo "Manifest.toml not found"
          cp -r data _site/ || echo "Data folder not found"
          cp -r figures _site/ 2>/dev/null || echo "Figures folder not found"

      - name: Upload paper artifacts
        if: steps.check-outputs.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: paper-outputs-${{ github.sha }}
          path: |
            index.pdf
            index.docx
            case-studies.pdf
            case-studies.docx
            Project.toml
            Manifest.toml
            data/
            figures/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload paper site artifact
        if: steps.check-outputs.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: paper-site
          path: _site/
          retention-days: 1

  # Job 2: Build EpiAware documentation (with submodule SHA caching)
  build-epiaware-docs:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-epiaware-docs.outputs.cache-hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Get EpiAware submodule SHA
        id: epiaware-sha
        run: echo "sha=$(git rev-parse HEAD:EpiAware)" >> $GITHUB_OUTPUT

      - name: Cache EpiAware docs
        id: cache-epiaware-docs
        uses: actions/cache@v4
        with:
          path: EpiAware/EpiAware/docs/build
          key: epiaware-docs-${{ steps.epiaware-sha.outputs.sha }}

      - name: Setup Julia
        if: steps.cache-epiaware-docs.outputs.cache-hit != 'true'
        uses: julia-actions/install-juliaup@v2
        with:
          channel: '1.11.6'

      - name: Set Julia version as default
        if: steps.cache-epiaware-docs.outputs.cache-hit != 'true'
        run: juliaup override set 1.11.6

      - name: Cache Julia for docs
        if: steps.cache-epiaware-docs.outputs.cache-hit != 'true'
        uses: julia-actions/cache@v2
        with:
          cache-name: julia-epiaware-docs-${{ hashFiles('EpiAware/EpiAware/docs/Project.toml') }}
          cache-registries: true
          cache-compiled: true

      - name: Build EpiAware docs
        if: steps.cache-epiaware-docs.outputs.cache-hit != 'true'
        continue-on-error: true
        run: |
          julia +1.11.6 --project=EpiAware/EpiAware/docs -e '
            using Pkg
            Pkg.develop(path="EpiAware/EpiAware")
            Pkg.instantiate()
            Pkg.precompile()
            include("EpiAware/EpiAware/docs/make.jl")
          '
        env:
          JULIA_NUM_THREADS: auto
          CI: true

      - name: Upload EpiAware docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: epiaware-docs
          path: EpiAware/EpiAware/docs/build/
          retention-days: 1
          if-no-files-found: warn

  # Job 3: Build EpiAwareR documentation (with submodule SHA caching)
  build-epiawarer-docs:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-epiawarer-docs.outputs.cache-hit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Get EpiAwareR submodule SHA
        id: epiawarer-sha
        run: echo "sha=$(git rev-parse HEAD:EpiAwareR)" >> $GITHUB_OUTPUT

      - name: Cache EpiAwareR docs
        id: cache-epiawarer-docs
        uses: actions/cache@v4
        with:
          path: EpiAwareR/docs
          key: epiawarer-docs-${{ steps.epiawarer-sha.outputs.sha }}

      - name: Setup R
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup pandoc
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        uses: r-lib/actions/setup-pandoc@v2

      - name: Setup Julia for EpiAwareR
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        uses: julia-actions/install-juliaup@v2
        with:
          channel: '1.11.6'

      - name: Set Julia version as default
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        run: juliaup override set 1.11.6

      - name: Cache renv
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: renv/library
          key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      - name: Restore renv
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        run: |
          Rscript -e 'renv::restore()'

      - name: Install EpiAwareR and pkgdown
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        run: |
          Rscript -e '
            renv::install("pkgdown")
            renv::install("remotes")
            remotes::install_local("EpiAwareR", dependencies = FALSE, upgrade = "never")
          '

      - name: Setup JuliaCall
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        uses: epiforecasts/actions/setup-juliacall@v1

      - name: Setup EpiAwareR Julia backend
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        run: |
          Rscript -e 'EpiAwareR::epiaware_setup_julia(verbose = TRUE)'

      - name: Build EpiAwareR pkgdown site
        if: steps.cache-epiawarer-docs.outputs.cache-hit != 'true'
        continue-on-error: true
        run: |
          Rscript -e 'pkgdown::build_site("EpiAwareR", new_process = FALSE)'

      - name: Upload EpiAwareR docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: epiawarer-docs
          path: EpiAwareR/docs/
          retention-days: 1
          if-no-files-found: warn

  # Job 4: Deploy all artifacts to GitHub Pages
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [render-paper, build-epiaware-docs, build-epiawarer-docs]
    steps:
      - name: Download paper site artifact
        uses: actions/download-artifact@v4
        with:
          name: paper-site
          path: _site/

      - name: Download EpiAware docs artifact
        uses: actions/download-artifact@v4
        with:
          name: epiaware-docs
          path: _site/epiaware/
        continue-on-error: true

      - name: Download EpiAwareR docs artifact
        uses: actions/download-artifact@v4
        with:
          name: epiawarer-docs
          path: _site/epiawarer/
        continue-on-error: true

      - name: List site structure
        run: |
          echo "Site structure:"
          find _site -type f | head -50

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
